name: Delete All Workflow Runs

on:
  workflow_dispatch:   # 手动触发

jobs:
  delete_runs:
    runs-on: ubuntu-latest

    permissions:
      actions: write   # 必须：允许删除 workflow 运行记录

    steps:
      - name: Delete all workflow runs
        run: |
          echo "开始删除所有 workflow 执行记录..."

          # 获取所有 workflow IDs
          WORKFLOWS=$(gh api repos/${{ github.repository }}/actions/workflows --jq '.workflows[].id')

          for WF_ID in $WORKFLOWS; do
            echo "处理 workflow ID: $WF_ID"

            # 获取该 workflow 的所有运行记录 ID
            RUNS=$(gh api repos/${{ github.repository }}/actions/workflows/$WF_ID/runs --jq '.workflow_runs[].id')

            for RUN_ID in $RUNS; do
              echo "删除 run ID: $RUN_ID"
              gh api \
                --method DELETE \
                repos/${{ github.repository }}/actions/runs/$RUN_ID
            done
          done

          echo "所有 workflow 执行记录已删除完成。"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
